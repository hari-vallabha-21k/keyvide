<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KeyVibe - Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      cursor: none;
      position: relative;
    }
    .cursor-dot {
      position: fixed;
      top: 0; left: 0;
      width: 10px; height: 10px;
      background: #3b82f6;
      border-radius: 50%;
      pointer-events: none;
      transform: translate(-50%, -50%);
      transition: transform 0.1s ease-out, opacity 0.3s;
      z-index: 9999;
      mix-blend-mode: difference;
    }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 dark:from-gray-900 dark:to-gray-800 text-black dark:text-white transition-colors duration-500">

  <div id="cursorDot" class="cursor-dot"></div>

  <div class="container mx-auto px-4 py-8">
    <div class="flex justify-end mb-4">
      <button id="darkModeToggle" class="px-4 py-2 rounded-md bg-gray-200 dark:bg-gray-700 text-black dark:text-white transition">Toggle Dark Mode</button>
    </div>

    <div class="text-center mb-8">
      <h1 class="text-4xl font-bold mb-2">KeyVibe - Analytics Dashboard</h1>
      <p>Track your typing patterns and mood trends over time</p>
    </div>

    <div class="flex justify-center mb-8">
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-1 flex space-x-2">
        <a href="/" class="px-6 py-2 rounded-md text-black dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700 font-medium transition-colors">
          Typing Test
        </a>
        <button id="dashboardTab" class="px-6 py-2 rounded-md bg-blue-500 text-white font-medium transition-colors">
          Dashboard
        </button>
      </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm font-medium">Total Sessions</p>
            <p id="totalSessions" class="text-2xl font-bold">0</p>
          </div>
        </div>
      </div>
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm font-medium">Avg Speed</p>
            <p id="avgSpeedStat" class="text-2xl font-bold">0 WPM</p>
          </div>
          <div class="text-3xl">âš¡</div>
        </div>
      </div>
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm font-medium">Avg Focus</p>
            <p id="avgFocusStat" class="text-2xl font-bold">0</p>
          </div>
        </div>
      </div>
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm font-medium">Avg Stress</p>
            <p id="avgStressStat" class="text-2xl font-bold">0</p>
          </div>
        </div>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6">
        <h3 class="text-xl font-semibold mb-4">7-Day Mood Trends</h3>
        <canvas id="moodTrendsChart" width="400" height="200"></canvas>
      </div>
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6">
        <h3 class="text-xl font-semibold mb-4">Recent Performance</h3>
        <canvas id="performanceChart" width="400" height="200"></canvas>
      </div>
    </div>

    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-semibold">Recent Sessions</h3>
        <button id="exportBtn" class="bg-green-500 hover:bg-green-600 text-black dark:text-white px-4 py-2 rounded-md transition-colors">
          Export CSV
        </button>
      </div>
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
          <thead class="bg-gray-50 dark:bg-gray-700">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Date</th>
              <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Speed</th>
              <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Focus</th>
              <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Stress</th>
              <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Confidence</th>
              <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Mood</th>
            </tr>
          </thead>
          <tbody id="sessionsTable" class="bg-white dark:bg-gray-900 divide-y divide-gray-200 dark:divide-gray-700">
          </tbody>
        </table>
      </div>
    </div>

    <div id="loadingState" class="text-center py-8">
      <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
      <p class="mt-2">Loading your data...</p>
    </div>
  </div>

  <script>
    // Dark mode toggle logic
    const darkModeToggle = document.getElementById('darkModeToggle');
    const htmlEl = document.documentElement;

    if (
      localStorage.getItem('theme') === 'dark' ||
      (!localStorage.getItem('theme') && window.matchMedia('(prefers-color-scheme: dark)').matches)
    ) {
      htmlEl.classList.add('dark');
    }

    darkModeToggle.addEventListener('click', () => {
      htmlEl.classList.toggle('dark');
      if (htmlEl.classList.contains('dark')) {
        localStorage.setItem('theme', 'dark');
      } else {
        localStorage.setItem('theme', 'light');
      }
    });

    // Cursor dot effect
    const cursorDot = document.getElementById('cursorDot');
    window.addEventListener('mousemove', (e) => {
      cursorDot.style.left = e.clientX + 'px';
      cursorDot.style.top = e.clientY + 'px';
    });

    // Placeholder variables for charts instance
    let moodTrendsChart = null;
    let performanceChart = null;

    // Function to fetch and update dashboard data
    async function loadDashboardData() {
      try {
        // Fetch stats and sessions JSON from your backend APIs
        const statsResponse = await fetch('/api/stats');
        const stats = await statsResponse.json();

        const sessionsResponse = await fetch('/api/sessions?limit=10');
        const sessions = await sessionsResponse.json();

        // Update stats display elements
        document.getElementById('totalSessions').textContent = stats.totalSessions;
        document.getElementById('avgSpeedStat').textContent = `${stats.avgSpeed} WPM`;
        document.getElementById('avgFocusStat').textContent = Math.round(stats.avgFocus);
        document.getElementById('avgStressStat').textContent = Math.round(stats.avgStress);

        // Update sessions table
        updateSessionsTable(sessions.sessions);

        // Update charts
        updateMoodTrendsChart(stats.moodTrends);
        updatePerformanceChart();

        // Hide loading spinner
        document.getElementById('loadingState').style.display = 'none';

      } catch (error) {
        console.error('Error loading dashboard data:', error);
        document.getElementById('loadingState').innerHTML = '<p class="text-red-600">Error loading data</p>';
      }
    }

    function updateSessionsTable(sessions) {
      const tbody = document.getElementById('sessionsTable');
      tbody.innerHTML = '';
      sessions.forEach(session => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td class="px-6 py-4 whitespace-nowrap text-sm text-black dark:text-white">${new Date(session.session_date).toLocaleDateString()}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-black dark:text-white">${Math.round(session.avg_keystroke_speed)} WPM</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-black dark:text-white">${Math.round(session.focus_score)}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-black dark:text-white">${Math.round(session.stress_score)}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-black dark:text-white">${Math.round(session.confidence_score)}</td>
          <td class="px-6 py-4 whitespace-nowrap"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${getMoodColor(session.dominant_mood)}">${session.dominant_mood}</span></td>
        `;
        tbody.appendChild(row);
      });
    }

    function getMoodColor(mood) {
      const colors = {
        'focus': 'bg-blue-100 text-blue-800',
        'confidence': 'bg-green-100 text-green-800',
        'stress': 'bg-red-100 text-red-800',
        'neutral': 'bg-gray-100 text-black dark:text-white'
      };
      return colors[mood] || colors.neutral;
    }

    function updateMoodTrendsChart(moodTrends) {
      const ctx = document.getElementById('moodTrendsChart').getContext('2d');
      if (moodTrendsChart) {
        moodTrendsChart.destroy();
      }
      moodTrendsChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: moodTrends.map(t => new Date(t.date).toLocaleDateString()),
          datasets: [
            {
              label: 'Focus',
              data: moodTrends.map(t => t.focus),
              borderColor: 'rgb(59, 130, 246)',
              backgroundColor: 'rgba(59, 130, 246, 0.1)',
              tension: 0.4
            },
            {
              label: 'Stress',
              data: moodTrends.map(t => t.stress),
              borderColor: 'rgb(239, 68, 68)',
              backgroundColor: 'rgba(239, 68, 68, 0.1)',
              tension: 0.4
            },
            {
              label: 'Confidence',
              data: moodTrends.map(t => t.confidence),
              borderColor: 'rgb(34, 197, 94)',
              backgroundColor: 'rgba(34, 197, 94, 0.1)',
              tension: 0.4
            }
          ]
        },
        options: {
          responsive: true,
          plugins: { legend: { position: 'top' } },
          scales: { y: { beginAtZero: true, max: 100 } }
        }
      });
    }

    function updatePerformanceChart() {
      // Placeholder: implement your actual performance data loading here
      const ctx = document.getElementById('performanceChart').getContext('2d');
      if (performanceChart) {
        performanceChart.destroy();
      }
      performanceChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
          datasets: [{
            label: 'Average WPM',
            data: [55, 46, 77, 60, 48, 50, 70], // Replace with actual data
            backgroundColor: 'rgba(59, 130, 246, 0.6)',
            borderColor: 'rgb(59, 130, 246)',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { display: false } },
          scales: { y: { beginAtZero: true } }
        }
      });
    }

    // Export CSV functionality placeholder
    document.getElementById('exportBtn').addEventListener('click', async () => {
      try {
        const response = await fetch('/api/export');
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        a.download = `typing_history_${new Date().toISOString().split('T')[0]}.csv`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
      } catch (e) {
        alert('Failed to export CSV.');
      }
    });

    // Load data on page load
    document.addEventListener('DOMContentLoaded', loadDashboardData);
  </script>
</body>
</html>
